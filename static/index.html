
<html>
  <head>
    <title>Carplay</title>
    <script type="text/javascript" src="./jsmpeg.min.js"></script>
  </head>
  <style>
  body {
    height: 100%;
    width: 100%;
    margin: 0;
  }
  canvas {
    height: auto;
    width: 100%;
    margin: 0;
    padding: 0;
    vertical-align: bottom;
  }
  </style>
  <body>
    <canvas id="video-canvas"
            ontouchstart="handleDown(event)"
            ontouchend="handleUp(event)"
            ontouchmove="handleMove(event)"
            onmousedown="handleMDown(event)"
            onmouseup="handleMUp(event)"
            onmousemove="handleMMove(event)"></canvas>
  </body>
  <script>

  const host = window.location.hostname + ":" + window.location.port

  var height = 0
  var width = 0
  var mouseDown = false
  var lastX = 0
  var lastY = 0

  var ws = new WebSocket('ws://'+host+'/ws/control');
  ws.onopen = function () {
      console.log('Websocket Control is connected ...')
      let data = {
        type: 'statusReq'
      }
      ws.send(JSON.stringify(data))
  }
  ws.onmessage = function (message) {
      message = JSON.parse(message.data)
      //console.log(message);
      if (message.type == 'statusReq') {
            if (message.data == 'plugged') {
                  console.log("IPhone is plugged");
            } else if (message.data == 'unplugged') {
                  console.log("IPhone is unplugged");
            }
      }
  }

  var canvas = document.getElementById('video-canvas')
  var url = 'ws://'+host+'/ws/video';
  var width = window.innerWidth;
  var height = width*717/848;
  canvas.width = width;
  canvas.height = height;
  var player = new JSMpeg.Player(url, {
      canvas: canvas,
      autoplay: true
  });

  function handleMDown(e) {
    //console.log("touched", e, e.target.getBoundingClientRect())
    let currentTargetRect = e.target.getBoundingClientRect();
    let x = e.clientX - currentTargetRect.left
    let y = e.clientY - currentTargetRect.top
    lastX = x / width
    lastY = y / height
    mouseDown = true
    let data = {
      type: 'click',
      data: {type: 14, x: x, y: y}
    }
    ws.send(JSON.stringify(data))
  }

  function handleMUp(e) {
      //console.log("touched end", e)
      let currentTargetRect = e.target.getBoundingClientRect();
      let x = e.clientX - currentTargetRect.left
      let y = e.clientY - currentTargetRect.top
      x = x / width
      y = y / height
      mouseDown = false
      let data = {
        type: 'click',
        data: {type: 16, x: x, y: y}
      }
      ws.send(JSON.stringify(data))
  }

  function handleMMove(e) {
      if (mouseDown) {
        //console.log("touched drag", e)
        let currentTargetRect = e.target.getBoundingClientRect();
        let x = e.clientX - currentTargetRect.left
        let y = e.clientY - currentTargetRect.top
        x = x / width
        y = y / height
        let data = {
          type: 'click',
          data: {type: 15, x: x, y: y}
        }
        ws.send(JSON.stringify(data))
      }
  }

  function handleDown(e) {
      //console.log("touched", e, e.target.getBoundingClientRect())
      let currentTargetRect = e.target.getBoundingClientRect();
      let x = e.touches[0].clientX - currentTargetRect.left
      let y = e.touches[0].clientY - currentTargetRect.top
      x = x / width
      y = y / height
      lastX = x
      lastY = y
      mouseDown = true
      let data = {
        type: 'click',
        data: {type: 14, x: x, y: y}
      }
      ws.send(JSON.stringify(data))
  }

  function handleUp(e) {
      //console.log("touched end", e)
      let currentTargetRect = e.target.getBoundingClientRect();
      let x = lastX
      let y = lastY
      mouseDown = false
      let data = {
        type: 'click',
        data: {type: 16, x: x, y: y}
      }
      ws.send(JSON.stringify(data))
  }

  function handleMove(e) {
      if (mouseDown) {
        //console.log("touched drag", e)
        let currentTargetRect = e.target.getBoundingClientRect();
        let x = e.touches[0].clientX - currentTargetRect.left
        let y = e.touches[0].clientY - currentTargetRect.top
        x = x / width
        y = y / height
        let data = {
          type: 'click',
          data: {type: 15, x: x, y: y}
        }
        ws.send(JSON.stringify(data))
      }
  }

  </script>
</html>
